# Binder 程序示例之 java 篇

**写给应用开发的 Android Framework 教程**是一个系列教程，目前已更新以下内容：

*   [Android Framework 学习路线指南](https://juejin.cn/post/7222901994839900215)

*   系统开发基础
    *   [Ubuntu 使用快速入门](https://juejin.cn/post/7203571284558381117)
    *   [Make 构建工具入门](https://juejin.cn/post/7203931072261193787)
    *   [理解 Unicode UTF-8 UTF-16 UTF-32](https://juejin.cn/post/7207365636694458425)
    *   [Linux Shell 脚本编程入门——核心基础语法](https://juejin.cn/post/7222931700439285817)
    *   [SEAndroid 使用极速上手](https://juejin.cn/post/7208472817460248637)
    *   [理解 C++ 的 Memory Order](https://juejin.cn/post/7216182763237146681)

*   AOSP 上手指南
    *   [AOSP 极速上手](https://juejin.cn/post/7202634945171537977)
    *   [系统开发工具推荐](https://juejin.cn/post/7216495812577427517)
    *   [添加 Product](https://juejin.cn/post/7203958049983529015)
    *   [添加 C/C++、Java 可执行程序](https://juejin.cn/post/7216624116337508412)
    *   [添加 C/C++、Java 库](https://juejin.cn/post/7217279252316045372)
    *   [添加配置文件与删除已有模块](https://juejin.cn/post/7217644586868391996)
    *   [系统 App 源码添加](https://juejin.cn/post/7207374216127103033)
    *   [使用 Android Studio 开发系统 App](https://juejin.cn/post/7207358268804579386)     
    *   [添加开机自启动 Shell 脚本](https://juejin.cn/post/7219712310586474553)

*   学穿 Binder 系列
    *   [Binder 基本原理](https://juejin.cn/post/7210175991837392933)
    *   [Binder 程序示例之 C 语言篇](https://juejin.cn/post/7210245482861264955)
    *   [Binder 服务注册过程情景分析之C语言篇](https://juejin.cn/post/7214342319347712057)
    *   [Binder 服务获取与使用过程情景分析之C语言篇](https://juejin.cn/post/7215401973842706491)
    *   [Binder C++ 程序示例](https://juejin.cn/post/7222109036588810297)
    *   [Binder C++ 程序分析之主要类解析](https://juejin.cn/post/7223185420157763641/)
    *   [Binder 服务注册过程情景分析之 C++ 篇](https://juejin.cn/post/7223185420157943865)
    *   Binder 服务获取与使用过程情景分析之 C++ 篇(本文)

*   HAL 与硬件服务
    *   [Kernel 下载与编译](https://juejin.cn/post/7207602567290765373)

    *   [Linux 驱动开发入门](https://juejin.cn/post/7207607724900810812)


本文基于 `AOSP Android10 r41` 源码环境

## 1. 定义 aidl 协议文件

```java
//IHelloService.aidl
package com.yuandaima;

interface IHelloService
{
	void sayhello();
	int sayhello_to(String name);
}
```

将 aidl 编译为 java 文件：

在系统源码下：

```bash
source build/envsetup.sh
aidl IHelloService.aidl
```
即可生成对于的 Java 文件 `IHelloService.aidl`


## 2. 实现 Hello 服务

```java
//HelloService.java
package com.yuandaima;

import android.util.Log;

public class HelloService extends IHelloService.Stub {
    private static final String TAG = "HelloService";
    private int cnt1 = 0;
    private int cnt2 = 0;

    public void sayhello() throws android.os.RemoteException {
        cnt1++;
        Log.i(TAG, "sayhello : cnt = "+cnt1);
    }
    
    public int sayhello_to(java.lang.String name) throws android.os.RemoteException {
        cnt2++;
        Log.i(TAG, "sayhello_to "+name+" : cnt = "+cnt2);
        return cnt2;
    }
}
```

## 3.实现服务端

```java
//Server.java
package com.yuandaima;

import android.util.Log;
import android.os.ServiceManager;

public class Server {

    private static final String TAG = "BinderServer";

    public static void main(String args[]) {
        /* add Service */
        Log.i(TAG, "add hello service");
        ServiceManager.addService("hello", new HelloService());

        //app_process 启动时，会启动 binder 线程用于获取和解析 binder 消息，应用程序无需关心
        while (true) {
            try {
            	Thread.sleep(100);
          	} catch (Exception e){}
        }   
    }
}
```

## 4.实现客户端

```java
//Client.java
package com.yuandaima;

import android.util.Log;
import android.os.ServiceManager;
import android.os.IBinder;

public class Client {

    private static final String TAG = "BinderClient";

    public static void main(String args[])
    {
        
        /* 1. getService */
        IBinder binder = ServiceManager.getService("hello");
        
        if (binder == null)
        {
            Log.i(TAG, "can not get hello service");
            return;
        }

        IHelloService svr = IHelloService.Stub.asInterface(binder);

        try {
	        svr.sayhello();
	        Log.i(TAG, "call sayhello");
        } catch (Exception e) {

        }
           
        try {
	        int cnt = svr.sayhello_to("hello");
	    
	        Log.i(TAG, "call sayhello_to " + " : cnt = " + cnt);
        } catch (Exception e) {
            System.out.println("call sayhello_to , err :"+e);
            Log.i(TAG, "call sayhello_to , err : "+e);
        }
    }
}
```


## 5. 编译运行

编写 Android.bp 文件：

```json
java_library {
    name: "BinderClient",
    installable: true,
    srcs: [ "com/yuandaima/Client.java", 
            "com/yuandaima/HelloService.java", 
            "com/yuandaima/IHelloService.java" ],
}

java_library {
    name: "BinderServer",
    installable: true,
    srcs: [ "com/yuandaima/Server.java", 
            "com/yuandaima/HelloService.java", 
            "com/yuandaima/IHelloService.java" ],
}
```


```bash
# 将项目源码放到系统源码下
# 在项目目录下执行
mm
# 将 jar 包 push 到虚拟机上
cd out/target/product/generic_x86_64/system/framework
adb push BinderClient.jar /data/local/tmp
adb push BinderServer.jar /data/local/tmp

# 执行 java 程序
export CLASSPATH=/data/local/tmp/BinderClient.jar:/data/local/tmp/BinderServer.jar
# 启动服务端
app_process /data/local/tmp  com.yuandaima.Server
# 启动客户端
app_process /data/local/tmp com.yuandaima.Client 
```

查看 log：

```bash
logcat | grep "BinderServer"

02-15 12:20:20.493  4171  4171 I BinderServer: add hello service

logcat | grep "BinderClient"

02-15 12:20:43.169  4183  4183 I BinderClient: call sayhello
02-15 12:20:43.169  4183  4183 I BinderClient: call sayhello_to  : cnt = 1
```